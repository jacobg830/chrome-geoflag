function getHost(e){var t;return t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0],t=t.split(":")[0]}function showFlag(e,t){chrome.pageAction.setIcon({tabId:e,path:"../../img/flags/"+currentCodeList[t]+".png"}),chrome.pageAction.show(e);var r=currentCountryList[t]+"\n";currentIPList[t]!==t&&(r+=t+"\n"),r+=currentIPList[t],chrome.pageAction.setTitle({tabId:e,title:r})}function fileExists(e){var t=new XMLHttpRequest;t.open("HEAD",e,!0),t.onload=function(e){return!0},t.onerror=function(e){return!1},t.send()}var currentIPList={},currentCountryList={},currentCodeList={};chrome.extension.onMessage.addListener(function(e,t,r){switch(e.type){case"getIP":var o=e.url;r(void 0!==currentIPList[getHost(o)]?{domainToIP:currentIPList[getHost(o)],domainToCountry:currentCountryList[getHost(o)]}:{domainToIP:"Unknown",domainToCountry:"Unknown"});break;default:r({})}}),chrome.webRequest.onResponseStarted.addListener(function(e){var t=e.ip,r=getHost(e.url);if(ipaddr.isValid(t)&&(t!==currentIPList[r]&&(currentIPList[r]=t,currentCountryList[r]=void 0),!currentCountryList[r])){if(ipaddr.IPv4.isValid(t))var o="GeoLite2-Country-Blocks-IPv4.csv";else var o="GeoLite2-Country-Blocks-IPv6.csv";Papa.parse("../../geolite2/"+o,{header:!0,download:!0,worker:!0,skipEmptyLines:!0,fastMode:!0,complete:function(o){var n=ipaddr.parse(t),i;o.data.forEach(function(e){var t=e.network.split("/"),r=ipaddr.parse(t[0]);n.match(r,t[1])&&(i=e.geoname_id)});var s=chrome.i18n.getUILanguage().replace("_","-");if(fileExists("../../geolite2/GeoLite2-Country-Locations-"+s+".csv"))var a=s;else var a="en";Papa.parse("../../geolite2/GeoLite2-Country-Locations-"+a+".csv",{header:!0,download:!0,worker:!0,skipEmptyLines:!0,fastMode:!0,complete:function(t){t.data.forEach(function(t){t.geoname_id===i&&(t.country_iso_code?(currentCodeList[r]=t.country_iso_code.toLowerCase(),currentCountryList[r]=t.country_name.replace(/"/g,"")):(currentCodeList[r]=t.continent_code.toLowerCase(),currentCountryList[r]=t.continent_name.replace(/"/g,"")),showFlag(e.tabId,r))})}})}})}},{urls:["<all_urls>"],types:["main_frame"]},[]),chrome.tabs.onUpdated.addListener(function(e,t,r){chrome.runtime.lastError||"undefined"==typeof currentCodeList[getHost(r.url)]||showFlag(e,getHost(r.url))});